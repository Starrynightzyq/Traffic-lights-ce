



#                           äº¤é€šç¯è®¾è®¡æŠ¥å‘Š

[TOC]

## ä¸€ã€è®¾è®¡ç›®çš„

è®¾è®¡ä¸€ä¸ªä¸»å‰¯å¹²é“åå­—è·¯å£çš„äº¤é€šä¿¡å·ç¯æ§åˆ¶ç”µè·¯ï¼Œæ§åˆ¶æŒ‡ç¤ºä¸»å‰¯ä¸¤æ¡äº¤å‰é“è·¯ä¸Šçš„è½¦è¾†é€šè¡Œã€‚

## äºŒã€ç³»ç»ŸåŠŸèƒ½å’Œè¦æ±‚

1. è®¾ä¸œè¥¿æ–¹å‘ä¸ºä¸»å¹²é“ï¼Œå—åŒ—æ–¹å‘ä¸ºå‰¯å¹²é“ã€‚ä¸œè¥¿ä¸»å¹²é“é€šè¡Œæ–¹å‘é€šæ—¶é—´è®¾å®šä¸º 45 ç§’ï¼Œå—åŒ—å‰¯å¹² é“é€šè¡Œæ–¹å‘æ—¶é—´ä¸º 30 ç§’ï¼›
2. åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šå„è®¾ä¸€ç»„çº¢é»„ç»¿ç¯ï¼Œåˆ†åˆ«ç”¨çº¢ã€é»„ã€ç»¿å‘å…‰äºŒæç®¡æ¨¡æ‹Ÿä¿¡å·ç¯ï¼›
3. æ¯æ¬¡ç”±ç»¿ç¯å˜ä¸ºçº¢ç¯æ—¶ï¼Œåº”æœ‰ 5 ç§’é»„ç¯äº®ä½œä¸ºè¿‡æ¸¡ï¼›é»„ç¯äº®æ—¶ï¼Œè¦æ±‚æ¯ç§’é’Ÿé—ªäº®ä¸€æ¬¡ï¼›
4. è¦æ±‚é»„ç¯å…ˆäº® 5 ç§’ï¼Œæ‰èƒ½å˜æ¢è¿è¡Œè½¦é“ï¼›
5. æ¯ä¸ªæ–¹å‘å„è®¾ç½®ä¸€ç»„æ•°ç ç®¡ï¼Œä»¥å€’è®¡æ—¶çš„æ–¹å¼æ˜¾ç¤ºå…è®¸é€šè¡Œæˆ–ç¦æ­¢é€šè¡Œæ—¶é—´ï¼›
6. æ¯ä¸ªæ–¹å‘å„è®¾ç½®ä¸€ç»„æ•°ç ç®¡ï¼Œä»¥å€’è®¡æ—¶çš„æ–¹å¼æ˜¾ç¤ºå…è®¸é€šè¡Œæˆ–ç¦æ­¢é€šè¡Œæ—¶é—´ï¼›
7. å¦‚æœå‘ç”Ÿç´§æ€¥äº‹ä»¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ§åˆ¶å››ä¸ªæ–¹å‘çº¢ç¯å…¨äº®ã€‚

## ä¸‰ã€ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

æ•´ä¸ªäº¤é€šæ§åˆ¶ç¯ç”µè·¯ä¸»è¦ç”±ä¸»æ§ç”µè·¯ã€å®šæ—¶ç”µè·¯ã€æ—¶é’Ÿä¿¡å·ã€æ˜¾ç¤ºç”µè·¯åŠå„æ¨¡å—ä¹‹é—´çš„ç¼“å†²ç”µè·¯ç­‰éƒ¨åˆ†ç»„æˆã€‚

![äº¤é€šç¯æ¡†å›¾](Pictures/äº¤é€šç¯æ¡†å›¾.png)

> â€‹                                                                               ç³»ç»Ÿæ•´ä½“æ¡†å›¾

### 1. æ—¶é’Ÿä¿¡å·

 æ—¶é’Ÿä¿¡å·ä¸ºBASTS3æ¿ä¸Š100MHzæ—¶é’Ÿä¿¡å·ï¼Œç»åˆ†é¢‘åä½œä¸ºç»™ä¸ªæ¨¡å—çš„æ—¶é’Ÿä¿¡å·ï¼›æ ¹æ®åŒæ­¥è®¾è®¡çš„åŸåˆ™ï¼Œæ‰€æœ‰æ¨¡å—å‡ä½¿ç”¨åŒä¸€ä¸ªæ—¶é’Ÿï¼Œåˆ†é¢‘åçš„ä¿¡å·ä½œä¸ºä½¿èƒ½ä¿¡å·ä½¿ç”¨ï¼›

### 2. å®šæ—¶ç”µè·¯ï¼ˆcountdown_doubleï¼‰

1. å®šæ—¶ç”µè·¯åŒæ­¥ç½®æ•°ï¼Œå…ˆå°†æ—¶é’Ÿä¿¡å·clkåš10000_0000åˆ†é¢‘å¾—åˆ°ä¸€ç§’é’Ÿä¿¡å·ï¼Œç”¨ä¸€ç§’é’Ÿä¿¡å·ä½œä¸ºè®¡æ•°å™¨çš„ä½¿èƒ½ä¿¡å·ï¼Œé€šè¿‡ç»„åˆé€»è¾‘ç”µè·¯è¾“å‡ºå€’è®¡æ—¶æ—¶é—´ï¼ˆä¸¤ä¸ª4ä½äºŒè¿›åˆ¶æ•°ï¼‰ï¼Œå½“è®¡æ•°åˆ°æœ€å°å€¼ï¼ˆdh_min,dl_minï¼‰æ—¶è¾“å‡ºä¸€ä¸ªè„‰å†²ä¿¡å·ï¼Œç„¶åé‡æ–°ä»æœ€å¤§å€¼ï¼ˆdhï¼Œdlï¼‰å¼€å§‹è®¡æ•°ï¼›

2. å› ä¸ºåœ¨ä¸œè¥¿æ–¹å‘å’Œå—åŒ—æ–¹å‘çš„è®¡æ•°æ—¶é—´æ˜¯ä¸ç›¸åŒçš„ï¼Œå› æ­¤ä½¿ç”¨ä¸¤ä¸ªå®šæ—¶ç”µè·¯åˆ†åˆ«æ§åˆ¶ä¸¤è·¯çš„æ—¶é—´ï¼›

   ~~~ verilog
   //åˆ†é¢‘éƒ¨åˆ†
   assign ms_next = (clr||(ms_reg == DVSR && en)) ? 0 :
     										  (en) ? ms_reg + 1 :
     												 ms_reg;
   assign ms_tick = (en)&&(ms_reg == DVSR) ? 1'b1 : 1'b0 //ä¸€ç§’é’Ÿä¿¡å·
   ~~~


### 3. ä¸»æ§ç”µè·¯ï¼ˆfsm_lightsï¼‰

![äº¤é€šç¯çŠ¶æ€å›¾](Pictures/fsm_traffic.png)

> â€‹                                                                              ä¸»æ§ç”µè·¯çŠ¶æ€å›¾

1. ä¸œè¥¿æ–¹å‘ä¸Šé»˜è®¤ä¸ºç»¿ç¯ï¼Œå—åŒ—æ–¹å‘ä¸Šé»˜è®¤ä¸ºçº¢ç¯ï¼›
2. æ¯æ¬¡changeå‘ç”Ÿï¼Œç¯çš„çŠ¶æ€è½¬æ¢ä¸€æ¬¡ï¼ŒåŒæ—¶è¾“å‡ºç›¸åº”çš„è®¡æ—¶çš„æœ€å¤§å€¼ã€‚

~~~ verilog
//ä¸œè¥¿æ–¹å‘
always@(*) begin
  time_next_2 = time_reg_2;
  lights_next_2 = lights_reg_2;
  if(reset) begin
    time_next_2 <= time_green_2; //ä¸œè¥¿æ–¹å‘ä¸Šé»˜è®¤ç»¿ç¯
    lights_next_2 <= green; 
  end else if(en) begin
    case(time_reg_2)
      time_red_2 : 
        if(change_2) begin
          time_next_2 = time_green_2;
          lights_next_2 = green;
        end else begin
          time_next_2 = time_red_2;
          lights_next_2 = red;
        end
      time_green_2 : 
        if(change_2) begin
          time_next_2 = time_yellow_2;
          lights_next_2 = yellow;
        end else begin
          time_next_2 = time_green_2;
          lights_next_2 = green;
        end
      time_yellow_2 : 
        if(change_2) begin
          time_next_2 = time_red_2;
          lights_next_2 = red;
        end else begin
          time_next_2 = time_yellow_2;
          lights_next_2 = yellow;
        end
      default : begin
        time_next_2 = time_green_2;
        lights_next_2 = green;
      end
    endcase
  end
end
~~~



### 4. ç´§æ€¥æƒ…å†µæ§åˆ¶ï¼ˆemergencyï¼‰

![ç´§æ€¥æƒ…å†µæ§åˆ¶2](Pictures/ç´§æ€¥æƒ…å†µæ§åˆ¶2.png)

---

![ç´§æ€¥æƒ…å†µæ§åˆ¶](Pictures/ç´§æ€¥æƒ…å†µæ§åˆ¶.png)



â€‹	ç´§æ€¥æƒ…å†µæ§åˆ¶ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

 1.  å¯åŠ¨/æš‚åœä¿¡å·ï¼ˆgoï¼‰å’Œç´§æ€¥æƒ…å†µä¿¡å·ï¼ˆemergencyï¼‰é€šè¿‡ç»„åˆé€»è¾‘æ„æˆå®šæ—¶ç”µè·¯ï¼ˆcountdown_doubleï¼‰å’Œä¸»æ§ç”µè·¯ï¼ˆfsm_lightsï¼‰çš„ä½¿èƒ½ä¿¡å·ï¼ˆenï¼‰,å½“å‡ºç°ç´§æ€¥æƒ…å†µæ—¶ï¼Œå®šæ—¶ç”µè·¯å’Œä¸»æ§ç”µè·¯æš‚åœï¼›

     ~~~ verilog
     assign en = go && (!emergency);
     ~~~

 2.  ç´§æ€¥æƒ…å†µå‡ºç°æ—¶(``` emergency = 1'b0 ```ï¼‰ï¼Œé€šè¿‡æ•°æ®é€‰æ‹©å™¨ï¼Œä½¿äº¤é€šç¯äº®çº¢ç¯ï¼ŒåŒæ—¶æ•°ç ç®¡æ˜¾ç¤º``` 88 ```;

     ~~~ verilog
     assign {qh,ql} = emergency ? {time_emergency,time_emergency}:{counterh,counterl};
     assign {lights_out} = emergency ? {lights_emergency} : {lights_in};
     ~~~

### 5. æ•°ç ç®¡æ˜¾ç¤ºç”µè·¯ï¼ˆscan_led_hex_dispï¼‰

![æ•°ç ç®¡æ˜¾ç¤ºç”µè·¯](Pictures/æ•°ç ç®¡æ˜¾ç¤ºç”µè·¯.png)

1. è¾“å…¥å››ä¸ª8421BCDç ï¼ˆ``` hex3,hex2,hex1,hex0 ```ï¼‰ï¼Œåˆ†åˆ«å¯¹åº”å››ä¸ªæ•°ç ç®¡ï¼Œå‰ä¸¤ä½ä¸ºä¸œè¥¿æ–¹å‘å€’è®¡æ—¶æ—¶é—´ï¼Œåä¸¤ä½ä¸ºå—åŒ—æ–¹å‘å€’è®¡æ—¶æ—¶é—´;

2. é‡‡ç”¨åŠ¨æ€æ‰«æçš„æ–¹å¼ï¼ˆæ‰«æé¢‘ç‡ä¸º``` 100MHZ/2^16 ```ï¼‰ï¼Œè¾“å‡ºä¸€ä¸ª8ä½æ®µé€‰ä¿¡å·ï¼ˆ``` sseg[7:0] ```ï¼‰å’Œä¸€ä¸ª4ä½ä½é€‰ä¿¡å·ï¼ˆ``` an ```ï¼‰;

   ~~~ verilog
   //åŠ¨æ€æ‰«æ
   always @ ( * ) begin
       case (regN[N-1:N-2])
         2'b00: begin an = 4'b1110; hex_in = hex0; dp = dp_in[0]; end
         2'b01: begin an = 4'b1101; hex_in = hex1; dp = dp_in[1]; end
         2'b10: begin an = 4'b1011; hex_in = hex2; dp = dp_in[2]; end
         default: begin an = 4'b0111; hex_in = hex3; dp = dp_in[3]; end
       endcase
   end
   ~~~

   ~~~ verilog
   //æ•°ç ç®¡ç¼–ç 
   always @ ( * ) begin
       case (hex_in)
           4'h0:sseg[6:0] = 7'b0000001;
           4'h1:sseg[6:0] = 7'b1001111;
           4'h2:sseg[6:0] = 7'b0010010;
           4'h3:sseg[6:0] = 7'b0000110;
           4'h4:sseg[6:0] = 7'b1001100;
           4'h5:sseg[6:0] = 7'b0100100;
           4'h6:sseg[6:0] = 7'b0100000;
           4'h7:sseg[6:0] = 7'b0001111;
           4'h8:sseg[6:0] = 7'b0000000;
           4'h9:sseg[6:0] = 7'b0000100;
           4'ha:sseg[6:0] = 7'b0001000;
           4'hb:sseg[6:0] = 7'b1100000;
           4'hc:sseg[6:0] = 7'b0110001;
           4'hd:sseg[6:0] = 7'b1000010;
           4'he:sseg[6:0] = 7'b0110000; 
         	default: sseg[6:0] = 7'b0111000; //4'hf
       endcase
     	sseg[7] = dp; //å°æ•°ç‚¹
   end
   ~~~

### 6. ç¼“å†²ç”µè·¯ï¼ˆä¸Šå‡æ²¿æ£€æµ‹ edge_triggerï¼‰

å½“å®šæ—¶ç”µè·¯å€’è®¡æ—¶ç»“æŸæ—¶ä¼šè¾“å‡ºä¸€ä¸ªè„‰å†²ä¿¡å·``` tick ```,ä½†è¿™ä¸ªä¿¡å·å®½åº¦ä¸º1sï¼Œå¦‚æœç›´æ¥ä½œä¸ºä¸‹ä¸€çº§ï¼ˆä¸»æ§ç”µè·¯ï¼‰çš„ä½¿èƒ½ä¿¡å·ï¼Œç”±äºä¸»æ§ç”µè·¯çš„æ—¶é’Ÿé¢‘ç‡ä¸º100MHzï¼Œç”µè·¯åœ¨1sæ—¶é—´é‡ŒæŒç»­ä½¿èƒ½ï¼Œç”µè·¯çš„çŠ¶æ€ä¼šä¸åœæ”¹å˜ï¼Œä¸å’Œé¢„æœŸè¦æ±‚ï¼Œå› æ­¤åŠ å…¥ä¸Šå‡æ²¿æ£€æµ‹ç”µè·¯ï¼Œæ£€æµ‹åˆ°ä¸Šå‡æ²¿åè¾“å‡ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„é«˜ç”µå¹³è„‰å†²ï¼Œä½œä¸ºä¸»æ§ç”µè·¯çš„ä½¿èƒ½ä¿¡å·ã€‚

![ä¸Šå‡æ²¿æ£€æµ‹ç”µè·¯](Pictures/ä¸Šå‡æ²¿æ£€æµ‹ç”µè·¯.png)

ä¸Šå‡æ²¿æ£€æµ‹ç”µè·¯ç”±ä¸€ä¸ªDè§¦å‘å™¨å’Œä¸€ä¸ªä¸é—¨æ„æˆï¼š

~~~ verilog
always@(posedge clk,posedge reset) begin
  if(reset) begin
    delay_reg <= 1'b0;
  end else begin
    delay_reg <= level;
  end
end
assign tick = ~delay_reg & level;
~~~

### 7. é»„ç¯é—ªçƒç”µè·¯ï¼ˆblinkï¼‰

![é»„ç¯é—ªçƒç”µè·¯](Pictures/é»„ç¯é—ªçƒç”µè·¯.png)

ä¸»æ§ç”µè·¯è¾“å‡ºçš„é»„ç¯ä¿¡å·ä½œä¸ºè¯¥ç”µè·¯çš„ä½¿èƒ½ä¿¡å·ï¼Œè¾“å‡ºä¸€ä¸ªå‘¨æœŸä¸º1sï¼Œå ç©ºæ¯”50%çš„ä¿¡å·ï¼Œæ¥åˆ°äº¤é€šç¯ğŸš¥çš„é»„ç¯ä¸Šï¼Œä½¿é»„ç¯å¯ä»¥æ¯éš”ä¸€ç§’é’Ÿé—ªçƒä¸€æ¬¡ï¼›

## å››ã€å°ç»“

## äº”ã€æ•´ä½“ç”µè·¯

![æ•´ä½“ç”µè·¯](Pictures/æ•´ä½“ç”µè·¯.png)

